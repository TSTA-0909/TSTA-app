<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>‰∫àÁ¥Ñ„Éö„Éº„Ç∏</title>
  <style>
    body { font-family: sans-serif; background: #f0f0f0; padding: 20px; }
    .calendar-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; margin-bottom: 20px; }
    table { border-collapse: collapse; }
    th, td { width: 36px; height: 36px; border: 1px solid #ccc; text-align: center; cursor: pointer; }
    td.today { background: #ffe4b2; }
    td.selected { background: #add8e6; transform: scale(1.2); font-weight: bold; }
    td.available { background: #c0ffc0; }
    .section { background: white; padding: 10px; border-radius: 6px; margin-bottom: 20px; max-width: 500px; }
    .reservation-list div { padding: 4px 0; }
    .reservation-list button { margin-left: 10px; }
    #noticeBox { background: #fffbe6; border-left: 6px solid #ffd700; padding: 10px; margin: 10px auto; max-width: 500px; }
  </style>
</head>
<body>

  <h1>‰∫àÁ¥Ñ„Ç´„É¨„É≥„ÉÄ„Éº</h1>

  <div class="calendar-container" id="calendarArea"></div>

  <!-- üîî „ÅäÁü•„Çâ„Åõ -->
  <div id="noticeBox" style="display:none;"></div>

  <div class="section">
    <h3>„ÅÇ„Å™„Åü„ÅÆ‰∫àÁ¥Ñ‰∏ÄË¶ß</h3>
    <div id="reservationList" class="reservation-list"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, where, deleteDoc, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC3pcdWqFwrvokCUyGGJlg_ruQ-6wUSZT8",
      authDomain: "tsta-reserve.firebaseapp.com",
      projectId: "tsta-reserve",
      storageBucket: "tsta-reserve.appspot.com",
      messagingSenderId: "242251329752",
      appId: "1:242251329752:web:f70718703ba8e35298a7ad"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const userName = prompt("„ÅÇ„Å™„Åü„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");

    function formatDate(date) {
      const jst = new Date(date.getTime() + 9 * 60 * 60 * 1000);
      return jst.toISOString().split("T")[0];
    }

    function renderCalendar(configMap) {
      const area = document.getElementById("calendarArea");
      area.innerHTML = "";
      const today = new Date();

      for (let m = 0; m < 2; m++) {
        const date = new Date(today.getFullYear(), today.getMonth() + m, 1);
        const table = document.createElement("table");
        const caption = document.createElement("caption");
        caption.textContent = `${date.getFullYear()}Âπ¥${date.getMonth() + 1}Êúà`;
        table.appendChild(caption);

        const head = document.createElement("tr");
        ["Êó•", "Êúà", "ÁÅ´", "Ê∞¥", "Êú®", "Èáë", "Âúü"].forEach(d => {
          const th = document.createElement("th");
          th.textContent = d;
          head.appendChild(th);
        });
        table.appendChild(head);

        const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
        const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);

        let row = document.createElement("tr");
        for (let i = 0; i < firstDay.getDay(); i++) {
          row.appendChild(document.createElement("td"));
        }

        for (let d = 1; d <= lastDay.getDate(); d++) {
          const day = new Date(date.getFullYear(), date.getMonth(), d);
          const dateStr = formatDate(day);
          const td = document.createElement("td");
          td.textContent = d;

          if (dateStr === formatDate(new Date())) td.classList.add("today");
          if (configMap[dateStr]) td.classList.add("available");

          td.onclick = () => {
            document.querySelectorAll("td").forEach(cell => cell.classList.remove("selected"));
            td.classList.add("selected");
            reserve(dateStr);
          };

          row.appendChild(td);
          if (day.getDay() === 6) {
            table.appendChild(row);
            row = document.createElement("tr");
          }
        }
        table.appendChild(row);
        area.appendChild(table);
      }
    }

    async function reserve(dateStr) {
      alert(`${dateStr} „Å´‰∫àÁ¥Ñ„ÇíÂÖ•„Çå„ÇãÂá¶ÁêÜÔºàÈñãÁô∫‰∏≠Ôºâ`);
    }

    async function loadReservations() {
      const q = query(collection(db, "reservations"), where("name", "==", userName));
      const snapshot = await getDocs(q);
      const listDiv = document.getElementById("reservationList");
      listDiv.innerHTML = "";

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.textContent = `${data.date}Ôºà${data.type === "beginner" ? "ÂàùÂøÉËÄÖ" : "ÁµåÈ®ìËÄÖ"}Ôºâ`;

        const btn = document.createElement("button");
        btn.textContent = "„Ç≠„É£„É≥„Çª„É´";
        btn.onclick = async () => {
          if (confirm("„Ç≠„É£„É≥„Çª„É´„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü")) {
            await deleteDoc(doc(db, "reservations", docSnap.id));
            loadReservations();
          }
        };

        div.appendChild(btn);
        listDiv.appendChild(div);
      });
    }

    async function loadConfig() {
      const snap = await getDocs(collection(db, "config"));
      const map = {};
      snap.forEach(doc => {
        if (doc.id !== "notice") map[doc.id] = doc.data();
      });
      renderCalendar(map);
    }

    async function loadNotice() {
      try {
        const docSnap = await getDoc(doc(db, "config", "notice"));
        if (docSnap.exists()) {
          const text = docSnap.data().text || "";
          const box = document.getElementById("noticeBox");
          if (text.trim()) {
            box.innerText = `üì¢ „ÅäÁü•„Çâ„ÅõÔºö${text}`;
            box.style.display = "block";
          }
        }
      } catch (e) {
        console.error("„ÅäÁü•„Çâ„ÅõÂèñÂæó„Ç®„É©„Éº:", e);
      }
    }

    window.onload = async () => {
      await loadConfig();
      await loadReservations();
      await loadNotice();
    };
  </script>
</body>
</html>
