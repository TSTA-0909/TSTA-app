<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰</title>
  <style>
    body { font-family: sans-serif; background: #f9f9f9; padding: 20px; }
    .calendar-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
    th, td { width: 36px; height: 36px; border: 1px solid #ccc; text-align: center; cursor: pointer; transition: transform 0.2s; }
    td.today { background: #ffe4b2; }
    td.selected { background: #add8e6; transform: scale(1.2); }
    td.disabled { background: #eee; color: #aaa; cursor: default; }
    td.available { background: #c0ffc0; }
    #popup { display: none; position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; z-index: 1000; }
    .reservation-list { margin-top: 20px; padding: 10px; background: #fff; border: 1px solid #ccc; border-radius: 5px; }
    .reservation-item { display: flex; justify-content: space-between; margin-bottom: 5px; }
    .reservation-item button { font-size: 12px; }
    .section { margin: 20px auto; max-width: 500px; padding: 10px; background: #fff; border: 1px solid #ccc; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>

  <label>åå‰ï¼š<input type="text" id="nameInput" placeholder="åå‰ã‚’å…¥åŠ›" /></label>
  <label>åŒºåˆ†ï¼š
    <select id="type">
      <option value="">-- é¸æŠ --</option>
      <option value="beginner">åˆå¿ƒè€…ãƒ»ãƒ–ãƒ©ãƒ³ã‚¯æœ‰</option>
      <option value="experienced">çµŒé¨“è€…</option>
    </select>
  </label>
  <button id="reserveBtn">äºˆç´„ã™ã‚‹</button>

  <div class="calendar-container" id="calendarArea"></div>
  <div id="popup">äºˆç´„ã§ãã¾ã—ãŸï¼æ¥½ã—ã¿ã«ã—ã¦ã¾ã™âœ¨</div>

  <!-- ğŸ“¢ ãŠçŸ¥ã‚‰ã›è¡¨ç¤º -->
  <div class="section">
    <h3>ğŸ“¢ ãŠçŸ¥ã‚‰ã›</h3>
    <p id="noticeText">èª­ã¿è¾¼ã¿ä¸­...</p>
  </div>

  <!-- âœ‰ï¸ ã‚³ãƒ¡ãƒ³ãƒˆé€ä¿¡ -->
  <div class="section">
    <h3>âœ‰ï¸ ã‚³ãƒ¡ãƒ³ãƒˆã‚’é€ã‚‹ï¼ˆç®¡ç†è€…ã«ã®ã¿å±Šãã¾ã™ï¼‰</h3>
    <textarea id="commentInput" rows="3" style="width: 100%;" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea><br>
    <button id="sendCommentBtn">ã‚³ãƒ¡ãƒ³ãƒˆé€ä¿¡</button>
    <p id="commentStatus"></p>
  </div>

  <!-- ğŸ—“ï¸ äºˆç´„ä¸€è¦§ -->
  <div class="reservation-list">
    <h3>ã‚ãªãŸã®äºˆç´„ä¸€è¦§</h3>
    <div id="reservationList"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, addDoc, query, where, serverTimestamp,
      doc, getDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC3pcdWqFwrvokCUyGGJlg_ruQ-6wUSZT8",
      authDomain: "tsta-reserve.firebaseapp.com",
      projectId: "tsta-reserve",
      storageBucket: "tsta-reserve.appspot.com",
      messagingSenderId: "242251329752",
      appId: "1:242251329752:web:f70718703ba8e35298a7ad"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let selectedDate = null;
    let config = {};

    async function loadConfigFromFirestore() {
      const snap = await getDocs(collection(db, "config"));
      snap.forEach(doc => {
        config[doc.id] = doc.data();
      });
      renderCalendar();
    }

    function renderCalendar() {
      const area = document.getElementById("calendarArea");
      area.innerHTML = "";
      const today = new Date();
      const type = document.getElementById("type").value;

      for (let m = 0; m < 2; m++) {
        const date = new Date(today.getFullYear(), today.getMonth() + m, 1);
        const table = document.createElement("table");
        const caption = document.createElement("caption");
        caption.textContent = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ`;
        table.appendChild(caption);

        const head = document.createElement("tr");
        ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"].forEach(d => {
          const th = document.createElement("th");
          th.textContent = d;
          head.appendChild(th);
        });
        table.appendChild(head);

        const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
        const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);
        let row = document.createElement("tr");
        for (let i = 0; i < firstDay.getDay(); i++) row.appendChild(document.createElement("td"));

        for (let d = 1; d <= lastDay.getDate(); d++) {
          const day = new Date(date.getFullYear(), date.getMonth(), d);
          const dateStr = day.toISOString().split("T")[0];
          const td = document.createElement("td");
          td.textContent = d;

          if (dateStr === new Date().toISOString().split("T")[0]) td.classList.add("today");

          if (config[dateStr]?.enabled && config[dateStr]?.[`${type}_limit`] > 0) {
            td.classList.add("available");
            td.onclick = () => {
              selectedDate = dateStr;
              document.querySelectorAll("td").forEach(cell => cell.classList.remove("selected"));
              td.classList.add("selected");
            };
          } else {
            td.classList.add("disabled");
          }

          row.appendChild(td);
          if (day.getDay() === 6) {
            table.appendChild(row);
            row = document.createElement("tr");
          }
        }

        table.appendChild(row);
        area.appendChild(table);
      }
    }

    async function registerReservation() {
      const name = document.getElementById("nameInput").value.trim();
      const type = document.getElementById("type").value;
      if (!name || !type || !selectedDate) {
        alert("åå‰ãƒ»åŒºåˆ†ãƒ»æ—¥ä»˜ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      await addDoc(collection(db, "reservations"), {
        name,
        type,
        date: selectedDate,
        time: "19:00",
        timestamp: serverTimestamp()
      });

      showPopup();
      loadUserReservations(name);
    }

    function showPopup() {
      const popup = document.getElementById("popup");
      popup.style.display = "block";
      setTimeout(() => popup.style.display = "none", 2000);
    }

    async function loadUserReservations(name) {
      const listDiv = document.getElementById("reservationList");
      listDiv.innerHTML = "";
      const q = query(collection(db, "reservations"), where("name", "==", name));
      const snap = await getDocs(q);
      snap.forEach(res => {
        const data = res.data();
        const div = document.createElement("div");
        div.className = "reservation-item";
        div.innerHTML = `${data.date}ï¼ˆ${data.type === "beginner" ? "åˆå¿ƒè€…" : "çµŒé¨“è€…"}ï¼‰ <button>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>`;
        div.querySelector("button").onclick = async () => {
          await deleteDoc(doc(db, "reservations", res.id));
          loadUserReservations(name);
          loadConfigFromFirestore();
        };
        listDiv.appendChild(div);
      });
    }

    // ğŸ”” ãŠçŸ¥ã‚‰ã›è¡¨ç¤º
    async function loadNotice() {
      const noticeRef = doc(db, "config", "notice");
      const noticeSnap = await getDoc(noticeRef);
      const noticeText = document.getElementById("noticeText");

      if (noticeSnap.exists() && noticeSnap.data().text) {
        noticeText.textContent = noticeSnap.data().text;
      } else {
        noticeText.textContent = "ç¾åœ¨ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
      }
    }

    // âœ‰ï¸ ã‚³ãƒ¡ãƒ³ãƒˆé€ä¿¡
    document.getElementById("sendCommentBtn").addEventListener("click", async () => {
      const name = document.getElementById("nameInput").value.trim();
      const comment = document.getElementById("commentInput").value.trim();
      const status = document.getElementById("commentStatus");

      if (!name || !comment) {
        status.textContent = "åå‰ã¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
        return;
      }

      try {
        await addDoc(collection(db, "comments"), {
          name,
          comment,
          timestamp: serverTimestamp()
        });
        status.textContent = "ã‚³ãƒ¡ãƒ³ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸï¼";
        document.getElementById("commentInput").value = "";
      } catch (e) {
        console.error("ã‚³ãƒ¡ãƒ³ãƒˆé€ä¿¡ã‚¨ãƒ©ãƒ¼:", e);
        status.textContent = "é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ";
      }
    });

    document.getElementById("type").addEventListener("change", renderCalendar);
    document.getElementById("reserveBtn").addEventListener("click", registerReservation);
    document.getElementById("nameInput").addEventListener("change", (e) => {
      const name = e.target.value.trim();
      if (name) loadUserReservations(name);
    });

    window.onload = () => {
      loadConfigFromFirestore();
      loadNotice();
    };
  </script>
</body>
</html>
