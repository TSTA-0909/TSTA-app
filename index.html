<!-- HTMLã®å†’é ­ã¨styleã¯çœç•¥ã—ã¾ã™ï¼ˆå‰å›ã®ã¾ã¾ã§OKï¼‰ -->
<!-- â†“ scriptéƒ¨åˆ†ã ã‘ã‚’å·®ã—æ›¿ãˆã¦ãã ã•ã„ -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
  import {
    getFirestore, collection, getDocs, addDoc, query, where, serverTimestamp,
    doc, getDoc, deleteDoc, onSnapshot
  } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js";
  import {
    getAuth, signInAnonymously, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC3pcdWqFwrvokCUyGGJlg_ruQ-6wUSZT8",
    authDomain: "tsta-reserve.firebaseapp.com",
    projectId: "tsta-reserve",
    storageBucket: "tsta-reserve.appspot.com",
    messagingSenderId: "242251329752",
    appId: "1:242251329752:web:f70718703ba8e35298a7ad"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth();

  let currentUser = null;
  let selectedDate = null;
  let config = {};

  // åŒ¿åãƒ­ã‚°ã‚¤ãƒ³
  signInAnonymously(auth)
    .then(() => console.log("åŒ¿åãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ"))
    .catch((error) => {
      console.error("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:", error);
      alert("ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ");
    });

  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      console.log("ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼UID:", user.uid);
      loadConfigFromFirestore();
      loadNotice();
    }
  });

  async function loadConfigFromFirestore() {
    const snap = await getDocs(collection(db, "config"));
    config = {};
    snap.forEach(doc => {
      config[doc.id] = doc.data();
    });
    renderCalendar();
  }

  function renderCalendar() {
    const area = document.getElementById("calendarArea");
    area.innerHTML = "";
    const today = new Date();
    const type = document.getElementById("type").value;

    for (let m = 0; m < 2; m++) {
      const date = new Date(today.getFullYear(), today.getMonth() + m, 1);
      const table = document.createElement("table");
      const caption = document.createElement("caption");
      caption.textContent = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ`;
      table.appendChild(caption);

      const head = document.createElement("tr");
      ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"].forEach(d => {
        const th = document.createElement("th");
        th.textContent = d;
        head.appendChild(th);
      });
      table.appendChild(head);

      const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
      const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);
      let row = document.createElement("tr");
      for (let i = 0; i < firstDay.getDay(); i++) row.appendChild(document.createElement("td"));

      for (let d = 1; d <= lastDay.getDate(); d++) {
        const day = new Date(date.getFullYear(), date.getMonth(), d);
        const dateStr = day.toISOString().split("T")[0];
        const td = document.createElement("td");
        td.textContent = d;

        if (dateStr === new Date().toISOString().split("T")[0]) td.classList.add("today");

        if (config[dateStr]?.enabled && config[dateStr]?.[`${type}_limit`] > 0) {
          td.classList.add("available");
          td.onclick = () => {
            selectedDate = dateStr;
            document.querySelectorAll("td").forEach(cell => cell.classList.remove("selected"));
            td.classList.add("selected");
          };
        } else {
          td.classList.add("disabled");
        }

        row.appendChild(td);
        if (day.getDay() === 6) {
          table.appendChild(row);
          row = document.createElement("tr");
        }
      }

      table.appendChild(row);
      area.appendChild(table);
    }
  }

  async function registerReservation() {
    const name = document.getElementById("nameInput").value.trim();
    const type = document.getElementById("type").value;
    if (!name || !type || !selectedDate) {
      alert("åå‰ãƒ»åŒºåˆ†ãƒ»æ—¥ä»˜ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }

    await addDoc(collection(db, "reservations"), {
      uid: currentUser.uid,
      name,
      type,
      date: selectedDate,
      time: "19:00",
      timestamp: serverTimestamp()
    });

    showPopup();
    loadUserReservations(name);
  }

  function showPopup() {
    const popup = document.getElementById("popup");
    popup.style.display = "block";
    setTimeout(() => popup.style.display = "none", 2000);
  }

  async function loadUserReservations(name) {
    const listDiv = document.getElementById("reservationList");
    listDiv.innerHTML = "";
    const q = query(collection(db, "reservations"), where("uid", "==", currentUser.uid));
    const snap = await getDocs(q);
    snap.forEach(res => {
      const data = res.data();
      const div = document.createElement("div");
      div.className = "reservation-item";
      div.innerHTML = `${data.date}ï¼ˆ${data.type === "beginner" ? "åˆå¿ƒè€…" : "çµŒé¨“è€…"}ï¼‰ <button>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>`;
      div.querySelector("button").onclick = async () => {
        await deleteDoc(doc(db, "reservations", res.id));
        loadUserReservations(name);
        loadConfigFromFirestore();
      };
      listDiv.appendChild(div);
    });
  }

  async function loadNotice() {
    const noticeRef = doc(db, "config", "notice");
    const noticeSnap = await getDoc(noticeRef);
    const noticeText = document.getElementById("noticeText");

    if (noticeSnap.exists() && noticeSnap.data().text) {
      noticeText.textContent = noticeSnap.data().text;
    } else {
      noticeText.textContent = "ç¾åœ¨ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
    }
  }

  async function setupChat(name) {
    const chatBox = document.getElementById("chatBox");
    chatBox.innerHTML = "<p>èª­ã¿è¾¼ã¿ä¸­...</p>";

    const q = query(collection(db, "comments"), where("uid", "==", currentUser.uid));
    onSnapshot(q, (snapshot) => {
      chatBox.innerHTML = "";
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.className = "chat-message " + (data.sender === "admin" ? "admin" : "user");
        div.innerHTML = `<span class="sender">${data.sender === "admin" ? "ğŸ›  ç®¡ç†è€…" : "ğŸ‘¤ ã‚ãªãŸ"}</span><span class="text">${data.text}</span>`;
        chatBox.appendChild(div);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  }

  async function sendComment() {
    const name = document.getElementById("nameInput").value.trim();
    const comment = document.getElementById("commentInput").value.trim();
    const status = document.getElementById("commentStatus");

    if (!name || !comment) {
      status.textContent = "åå‰ã¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
      return;
    }

    try {
      await addDoc(collection(db, "comments"), {
        uid: currentUser.uid,
        name,
        text: comment,
        sender: "user",
        timestamp: serverTimestamp(),
        readByAdmin: false,
        repliedByAdmin: false
      });
      status.textContent = "ã‚³ãƒ¡ãƒ³ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸï¼";
      document.getElementById("commentInput").value = "";
    } catch (e) {
      console.error("ã‚³ãƒ¡ãƒ³ãƒˆé€ä¿¡ã‚¨ãƒ©ãƒ¼:", e);
      status.textContent = "é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ";
    }
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
  document.getElementById("reserveBtn").addEventListener("click", registerReservation);
  document.getElementById("sendCommentBtn").addEventListener("click", sendComment);
  document.getElementById("commentInput").addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendComment();
    }
  });

  document.getElementById("nameInput").addEventListener("change", (e) => {
    const name = e.target.value.trim();
    if (name && currentUser) {
      loadUserReservations(name);
      setupChat(name);
    }
  });
</script>
