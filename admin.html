<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ç®¡ç†è€…ï¼šäºˆç´„æ—¥è¨­å®š</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
    .calendar-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
    table { border-collapse: collapse; }
    th, td { width: 36px; height: 36px; border: 1px solid #ccc; text-align: center; cursor: pointer; }
    td.today { background: #ffe4b2; }
    td.selected { background: #add8e6; transform: scale(1.2); font-weight: bold; }
    td.available { background: #c0ffc0; }
    td.disabled { background: #eee; color: #aaa; cursor: default; }
    .section { margin-top: 20px; background: white; padding: 10px; border-radius: 6px; max-width: 500px; }
    .name-list div { padding: 4px 0; }
    .name-list button { margin-left: 10px; }
  </style>
</head>
<body>
  <h1>ç®¡ç†è€…ï¼šäºˆç´„æ—¥è¨­å®š</h1>

  <div class="calendar-container" id="calendarArea"></div>

  <div class="section">
    <h3>ğŸ“¢ ãŠçŸ¥ã‚‰ã›ç®¡ç†</h3>
    <textarea id="noticeInput" rows="3" style="width: 100%;"></textarea><br>
    <button id="saveNoticeBtn">ãŠçŸ¥ã‚‰ã›ã‚’ä¿å­˜</button>
    <p id="noticeStatus"></p>
  </div>

  <div class="section">
    <h3>é¸æŠæ—¥ï¼š<span id="selectedDateDisplay">æœªé¸æŠ</span></h3>
    <label>åˆå¿ƒè€…ä¸Šé™ï¼š<input type="number" id="beginner" value="2"></label><br>
    <label>çµŒé¨“è€…ä¸Šé™ï¼š<input type="number" id="experienced" value="2"></label><br>
    <button id="saveBtn">äºˆç´„å¯èƒ½ã«ã™ã‚‹</button>
    <p id="status"></p>
  </div>

  <div class="section" id="reservationInfo" style="display:none;">
    <h3>ğŸ” å‚åŠ è€…ä¸€è¦§ï¼ˆé¸æŠæ—¥ï¼‰</h3>
    <div id="beginnerList" class="name-list"></div>
    <div id="experiencedList" class="name-list"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
    import {
      getFirestore, doc, setDoc, getDocs, collection, deleteDoc, query, where
    } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC3pcdWqFwrvokCUyGGJlg_ruQ-6wUSZT8",
      authDomain: "tsta-reserve.firebaseapp.com",
      projectId: "tsta-reserve",
      storageBucket: "tsta-reserve.appspot.com",
      messagingSenderId: "242251329752",
      appId: "1:242251329752:web:f70718703ba8e35298a7ad"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let selectedDate = null;
    let configMap = {};

    // JSTæ—¥ä»˜ã«å¤‰æ›
    function formatDate(date) {
      const jst = new Date(date.getTime() + (9 * 60 * 60 * 1000));
      return jst.toISOString().split("T")[0];
    }

    async function loadConfigFromFirestore() {
      const snap = await getDocs(collection(db, "config"));
      snap.forEach(doc => {
        configMap[doc.id] = doc.data();
      });
    }

    function renderCalendar() {
      const area = document.getElementById("calendarArea");
      area.innerHTML = "";
      const today = new Date();

      for (let m = 0; m < 2; m++) {
        const date = new Date(today.getFullYear(), today.getMonth() + m, 1);
        const table = document.createElement("table");
        const caption = document.createElement("caption");
        caption.textContent = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ`;
        table.appendChild(caption);

        const head = document.createElement("tr");
        ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"].forEach(d => {
          const th = document.createElement("th");
          th.textContent = d;
          head.appendChild(th);
        });
        table.appendChild(head);

        const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
        const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);

        let row = document.createElement("tr");
        for (let i = 0; i < firstDay.getDay(); i++) row.appendChild(document.createElement("td"));

        for (let d = 1; d <= lastDay.getDate(); d++) {
          const day = new Date(date.getFullYear(), date.getMonth(), d);
          const dateStr = formatDate(day); // JSTã«å¤‰æ›

          const td = document.createElement("td");
          td.textContent = d;

          if (dateStr === formatDate(new Date())) td.classList.add("today");
          if (configMap[dateStr]) td.classList.add("available");

          td.onclick = () => {
            selectedDate = dateStr;
            document.querySelectorAll("td").forEach(td => td.classList.remove("selected"));
            td.classList.add("selected");
            document.getElementById("selectedDateDisplay").textContent = selectedDate;
            loadReservations(dateStr);
          };

          row.appendChild(td);
          if (day.getDay() === 6) {
            table.appendChild(row);
            row = document.createElement("tr");
          }
        }

        table.appendChild(row);
        area.appendChild(table);
      }
    }

    async function saveConfig() {
      if (!selectedDate) {
        alert("æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„");
        return;
      }
      const beginner = parseInt(document.getElementById('beginner').value);
      const experienced = parseInt(document.getElementById('experienced').value);
      const config = {
        enabled: true,
        beginner_limit: beginner,
        experienced_limit: experienced
      };
    async function saveNotice() {
      const text = document.getElementById("noticeInput").value;
      try {
        await setDoc(doc(db, "config", "notice"), { text });
        document.getElementById("noticeStatus").textContent = "ãŠçŸ¥ã‚‰ã›ã‚’ä¿å­˜ã—ã¾ã—ãŸ";
      } catch (e) {
        console.error("ãŠçŸ¥ã‚‰ã›ä¿å­˜ã‚¨ãƒ©ãƒ¼:", e);
        document.getElementById("noticeStatus").textContent = "ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ";
      }
    }

      try {
        await setDoc(doc(db, "config", selectedDate), config);
        document.getElementById("status").textContent = `${selectedDate} ã®è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ`;
        configMap[selectedDate] = config;
        renderCalendar();
      } catch (e) {
        console.error("Firestore ä¿å­˜ã‚¨ãƒ©ãƒ¼:", e);
        document.getElementById("status").textContent = `ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ`;
      }
    }

    async function loadReservations(dateStr) {
      const q = query(collection(db, "reservations"), where("date", "==", dateStr));
      const snapshot = await getDocs(q);

      const beginner = [], experienced = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        const entry = { ...data, id: doc.id };
        if (data.type === "beginner") beginner.push(entry);
        else if (data.type === "experienced") experienced.push(entry);
      });

      const beginnerDiv = document.getElementById("beginnerList");
      const experiencedDiv = document.getElementById("experiencedList");
      const wrapper = document.getElementById("reservationInfo");

      wrapper.style.display = "block";
      beginnerDiv.innerHTML = `<h4>åˆå¿ƒè€…ï¼ˆ${beginner.length}äººï¼‰</h4>` + beginner.map(p => `<div>${p.name} <button onclick="cancel('${p.id}')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div>`).join("");
      experiencedDiv.innerHTML = `<h4>çµŒé¨“è€…ï¼ˆ${experienced.length}äººï¼‰</h4>` + experienced.map(p => `<div>${p.name} <button onclick="cancel('${p.id}')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div>`).join("");
    }

    window.cancel = async function(id) {
      if (!confirm("æœ¬å½“ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ")) return;
      await deleteDoc(doc(db, "reservations", id));
      loadReservations(selectedDate);
    }

    window.onload = async () => {
      await loadConfigFromFirestore();
      renderCalendar();
      document.getElementById("saveBtn").addEventListener("click", saveConfig);
      document.getElementById("saveNoticeBtn").addEventListener("click", saveNotice);

  // ğŸ”” ãŠçŸ¥ã‚‰ã›èª­ã¿è¾¼ã¿
      try {
        const docSnap = await getDoc(doc(db, "config", "notice"));
        if (docSnap.exists()) {
          document.getElementById("noticeInput").value = docSnap.data().text || "";
        }
      } catch (e) {
        console.error("ãŠçŸ¥ã‚‰ã›èª­ã¿è¾¼ã¿å¤±æ•—:", e);
      }
    };

  </script>
</body>
</html>
